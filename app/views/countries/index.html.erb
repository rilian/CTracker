<% if current_user.user_countries.size > 0 %>
  <script type="text/javascript">
    function drawVisualization() {
      // Create and populate the data table.
      var data = google.visualization.arrayToDataTable([
        ['x', 'Countries Visited'],

        <% current_user.user_countries.each_with_index do |uc, index| %>
          ['<%= uc.created_at.strftime('%d-%m-%Y') %>', <%= index + 1 %>],
        <% end %>
      ]);

      // Create and draw the visualization.
      new google.visualization.LineChart(document.getElementById('visualization')).
          draw(data, {curveType: "none",
            width: 340, height: 200,
            vAxis: {},
            chartArea: {left: 50, top: 30, width: 280, height: 150},
            legend: {position: 'top', textStyle: {color: 'blue', fontSize: 16}}
          }
      );
    }
    google.setOnLoadCallback(drawVisualization);
  </script>
<% end %>

<section>
  <h1>Countries</h1>

  <table>
    <tr>
      <td>
        <div id="visited_countries_chart" class="simple_pie_chart" width='300px' height='100px'>
          <table>
            <tr>
              <th>Visited</th>
              <td><%= current_user.countries.count %></td>
            </tr>
            <tr>
              <th>Not Visited</th>
              <td><%= current_user.not_visited_countries.count %></td>
            </tr>
          </table>
        </div>
      </td>
      <td>
        <div id="visualization" style="width: 340px; height: 200px;">No data for countries visited chart</div>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <div>
          <%= search_form_for @q do |f| %>
            <%= f.label :name_or_code_cont, 'Name or Country' %>
            <%= f.text_field :name_or_code_cont %>
            <%= f.submit %>
          <% end %>
        </div>
      </td>
    </tr>
  </table>

  <br/>

  <%= form_tag visit_multiple_countries_path, html: { method: :post }, class: 'countries_form', remote: true do %>
    <%= submit_tag 'Visit Selected Countries', :class => 'visit_countries' %>

    <table id="countries_table">
      <tr>
        <th><label for="select_all">Select all</label><input id="select_all" name="select_all" type="checkbox"></th>
        <th><%= sort_link @q, :name %></th>
        <th><%= sort_link @q, :code %></th>
        <th>Status</th>
        <th></th>
        <th></th>
      </tr>

    <% @countries.each do |country| %>
      <tr data-country_id="<%= country.id %>">
        <td class="checker"><%= check_box_tag('country_ids[]', country.id, false, { 'data-country_id' => country.id }) unless country.visited_by_user?(current_user) %></td>
        <td><%= country.name %></td>
        <td><%= country.code %></td>
        <td class="status"><%= country.visited_by_user?(current_user) ? 'Visited' : 'Not Visited' %></td>
        <td><%= link_to 'Show', country %></td>
        <td><%= link_to_if can?(:update, country), 'Edit', edit_country_path(country) %></td>
      </tr>
    <% end %>
    </table>

    <%= submit_tag 'Visit Selected Countries', :class => 'visit_countries' %>

  <% end %>
</section>
